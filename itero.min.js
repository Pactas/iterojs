function bindReady(n){function t(){r||(r=!0,n())}var r=!1,f,i;if(document.addEventListener)document.addEventListener("DOMContentLoaded",t,!1);else if(document.attachEvent){try{f=window.frameElement!=null}catch(e){}if(document.documentElement.doScroll&&!f){function u(){if(!r)try{document.documentElement.doScroll("left"),t()}catch(n){setTimeout(u,10)}}u()}document.attachEvent("onreadystatechange",function(){document.readyState==="complete"&&t()})}window.addEventListener?window.addEventListener("load",t,!1):window.attachEvent?window.attachEvent("onload",t):(i=window.onload,window.onload=function(){i&&i(),t()})}function IteroError(n){this.message=n||"",this.stack=(new Error).stack}function Itero(n,t){function e(){c||h!=null&&i.paymentMethods!=null&&y&&u&&(c=!0,t&&t(),i.onReady&&i.onReady())}function p(){if(!u){if(i.paymentMethods==null){f=p;return}i.paymentMethods.Paymill?(window.PAYMILL_PUBLIC_KEY=i.paymentMethods.Paymill.PublicKey,d("https://bridge.paymill.com/",function(){u=!0,e()})):(u=!0,e())}}function k(n,t,i,r){var e=typeof t=="array",u,f;for(u in t)f=t[u],r&&(u=i?r:r+"["+(e?"":u)+"]"),!r&&e?n.add(f.name,f.value):n.add(u,f)}function g(n,t){var i=[];return i.add=function(n,t){this.push(escape(n)+"="+escape(t))},k(i,n,t),i.join("&").replace("%20","+")}function d(n,t){var i,r,u;r=!1,i=document.createElement("script"),i.type="text/javascript",i.src=n,i.onload=i.onreadystatechange=function(){r||this.readyState&&this.readyState!="complete"||(r=!0,t())},head=document.getElementsByTagName("head")[0],head.appendChild(i)}function tt(n){return g(n,!0)}function l(n,t,i,r){var f=null,e,u;t=="PUT"||t=="POST"?f=JSON.stringify(i):(e=tt(i),e!=""&&(n=n+"?"+e)),window.XDomainRequest?(u=new window.XDomainRequest,u.onload=function(){r(JSON.parse(u.responseText))},u.open(t,n,!1),u.send(f)):(u=new XMLHttpRequest,u.onreadystatechange=function(){if(u.readyState==4)if(u.status==200){var n=JSON.parse(u.responseText);r&&r(n)}else throw new IteroError(u.statusText);},u.open(t,n,!0),u.setRequestHeader("Content-Type","text/plain"),u.send(f))}function a(n,t,i){return l(n,"POST",t,i)}function nt(n,t,i){return l(n,"GET",t,i)}function v(n,t,i){a(s+"CustomerSelfService/Preview",{order:n,customerData:t},function(n){i&&i(n)})}function w(t,i,r){var f=i.bearer,u;if(f=="CreditCard:Paymill")u={amount_int:t.Total*100,currency:t.Currency,number:i.cardNumber,exp_month:i.expiryMonth,exp_year:i.expiryYear,cvc:i.cvc,cardholder:i.cardHolder};else if(f=="Debit:Paymill")u={number:i.bankAccountNumber,bank:i.bankRoutingCode,accountholder:i.accountHolder};else throw new IteroError("Invalid payment method given to paymentPaymill!");debug.log("sending to paymill",u),paymill.createToken(u,function(n,t){n&&(debug.log("paymill error: ",n),r(n)),t&&(debug.log("paymill result: ",t),i={token:t.token,selectedPaymentMethod:f,bearer:f},r(i))},n.popupCreate,n.popupClose)}function b(n,t,i){if(!n)throw new IteroError("ArgumentMissing: order");if(!t)throw new IteroError("ArgumentMissing: paymentData");if(!i)throw new IteroError("ArgumentMissing: continuation");if(n.Total<0)throw new IteroError("Negative payments aren't supported");if(n.Currency==null||typeof n.Currency!="string"||n.Currency.length!=3)throw new IteroError("ArgumentError: order has no Currency, or Currency is not a valid 3-letter string: "+n.Currency);if(t)switch(t.bearer){case"Debit:Paymill":case"CreditCard:Paymill":w(n,t,i);break;case"PayPal":i({selectedPaymentMethod:"BlackLabel:PayPal"});break;case"Skrill":i({selectedPaymentMethod:"BlackLabel:Skrill"});break;default:throw new IteroError("Unknown payment bearer '"+t.bearer+"'!");}else throw new IteroError("Signup w/o payment information not yet implemented!");}var i=this,s="http://itero.demo.pactas.com/api/v1/",y=!1,h,f,c,u,o,r;this.paymentMethods=null,this.paymentMethodEnum=[],h=null,this.quote=null,f=null,nt(s+"CustomerSelfService/PaymentMethods",{appId:n.appId},function(n){var r,u,t;i.paymentMethods=n,r=Object.keys(n);for(u in r)t=r[u],n[t].CreditCard&&i.paymentMethodEnum.push("CreditCard:"+t),n[t].DirectDebit&&i.paymentMethodEnum.push("Debit:"+t),n[t].CreditCard||n[t].DirectDebit||i.paymentMethodEnum.push(t);f&&f(),e()}),n.initialOrder&&v(n.initialOrder,{},function(n){h=n,i.quote=n,e()}),bindReady(function(){y=!0,p()}),c=!1,u=!1,this.preview=function(n,t,i){o&&window.clearTimeout(o),o=setTimeout(function(){v(n,t,i)},700)},r=!1,this.abort=function(){r=!1},this.subscribe=function(n,t,i,u){if(!n)throw new IteroError("ArgumentMissing: order");if(!t)throw new IteroError("ArgumentMissing: customerData");if(!i)throw new IteroError("ArgumentMissing: secretPaymentData");if(!u)throw new IteroError("ArgumentMissing: callback");if(r)throw new IteroError("subscribe() is already running!");r=!0,b(n,i,function(i){(i==null||i.status=="error"||i.status=="aborted")&&(debug.log("subscribe / aborted!"),u({Error:"aborted"}),r=!1);var f={order:n,customerData:t,paymentData:i},e=a(s+"CustomerSelfService/Subscribe",f,function(n){u&&u(n),r=!1})})}}Object.keys=Object.keys||function(n,t,i){i=[];for(t in n)i.hasOwnProperty.call(n,t)&&i.push(t);return i},IteroError.prototype=new Error,IteroError.prototype.name="IteroError"